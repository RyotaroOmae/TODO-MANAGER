#!/bin/bash

STATE_DIR="$HOME/.todo_state"
mkdir -p "$STATE_DIR"

# 設定（環境変数で上書き可）
TODO_LISTS_DEFAULT="prior tmrr today"
TODO_LISTS="${TODO_LISTS:-$TODO_LISTS_DEFAULT}"

TODO_TMRR_KEY="${TODO_TMRR_KEY:-tmrr}"
TODO_TODAY_KEY="${TODO_TODAY_KEY:-today}"

# -------------------------------
# Utils
# -------------------------------

# list名が TODO_LISTS に含まれるか（完全一致）
is_valid_list() {
  local key="$1"
  for k in $TODO_LISTS; do
    if [ "$k" = "$key" ]; then
      return 0
    fi
  done
  return 1
}

# macOS/Linux 両対応の「指定行削除」
delete_line_in_file() {
  local file="$1"
  local num="$2"

  local tmp
  tmp=$(mktemp)
  awk -v n="$num" 'NR != n { print }' "$file" > "$tmp" && mv "$tmp" "$file"
}

# 昨日の日付（YYYY-MM-DD）を macOS/Linux 両対応で取得
get_yesterday() {
  if date -d "yesterday" +%F >/dev/null 2>&1; then
    date -d "yesterday" +%F
  else
    date -v-1d +%F
  fi
}

# -------------------------------
# Core: list handler
# -------------------------------
handle_list() {
  local key="$1"
  shift
  local file="$STATE_DIR/$key"
  local subcmd="$1"

  # reset
  if [ "$subcmd" = "reset" ]; then
    : > "$file"
    echo "$key list reset"
    return
  fi

  # del: 指定番号を削除
  if [ "$subcmd" = "del" ]; then
    local num="$2"
    if ! [[ "$num" =~ ^[0-9]+$ ]]; then
      echo "Usage: todo $key del <number>"
      return
    fi

    if [ ! -s "$file" ]; then
      echo "$key list is empty"
      return
    fi

    delete_line_in_file "$file" "$num"
    echo "deleted line $num from $key"
    return
  fi

  # 引数なし → 表示
  if [ -z "$subcmd" ]; then
    if [ ! -s "$file" ]; then
      echo "$key list is empty"
      return
    fi

    echo "$key list:"

    # tmrr（= TODO_TMRR_KEY）は "日付<TAB>本文" を本文だけ表示
    if [ "$key" = "$TODO_TMRR_KEY" ]; then
      awk '
        {
          n++
          split($0, a, "\t")
          if (length(a) > 1) {
            printf "%6d  %s\n", n, a[2]
          } else {
            printf "%6d  %s\n", n, $0
          }
        }
      ' "$file"
    else
      nl -ba "$file"
    fi

    return
  fi

  # 追加（2つ目以降全部）
  local item="${*:1}"

  if [ "$key" = "$TODO_TMRR_KEY" ]; then
    local today_str
    today_str=$(date +%F)
    printf '%s\t%s\n' "$today_str" "$item" >> "$file"
  else
    echo "$item" >> "$file"
  fi

  echo "added to $key: $item"
}

show_all_lists() {
  for key in $TODO_LISTS; do
    echo "=== $key ==="
    handle_list "$key"
    echo
  done
}

# -------------------------------
# update: tmrr -> today
# -------------------------------
update_tmrr_to_today() {
  local tmrr_file="$STATE_DIR/$TODO_TMRR_KEY"
  local today_file="$STATE_DIR/$TODO_TODAY_KEY"

  local yesterday
  yesterday=$(get_yesterday)

  if [ ! -s "$tmrr_file" ]; then
    echo "$TODO_TMRR_KEY list is empty; nothing to update"
    return
  fi

  local tmp
  tmp=$(mktemp)

  local moved_count=0

  while IFS= read -r line; do
    if [[ "$line" == *$'\t'* ]]; then
      local date_part text_part
      date_part=${line%%$'\t'*}
      text_part=${line#*$'\t'}

      if [ "$date_part" = "$yesterday" ]; then
        echo "$text_part" >> "$today_file"
        moved_count=$((moved_count + 1))
      else
        echo "$line" >> "$tmp"
      fi
    else
      echo "$line" >> "$tmp"
    fi
  done < "$tmrr_file"

  mv "$tmp" "$tmrr_file"

  echo "moved $moved_count item(s) written on $yesterday from $TODO_TMRR_KEY to $TODO_TODAY_KEY"
}

print_usage() {
  echo "Usage:"
  echo "  todo                     # show all lists (from TODO_LISTS)"
  echo "  todo <list>              # show a list"
  echo "  todo <list> TEXT...      # add an item to a list"
  echo "  todo <list> del N        # delete Nth item"
  echo "  todo <list> reset        # reset list"
  echo "  todo update              # move yesterday's $TODO_TMRR_KEY items to $TODO_TODAY_KEY"
  echo
  echo "Config:"
  echo "  TODO_LISTS=\"prior tmrr today ...\""
  echo "  TODO_TMRR_KEY=tmrr"
  echo "  TODO_TODAY_KEY=today"
}

# -------------------------------
# Main
# -------------------------------

# 引数なし: すべてのリストを表示
if [ $# -eq 0 ]; then
  show_all_lists
  exit 0
fi

# update は固定サブコマンド
if [ "$1" = "update" ]; then
  update_tmrr_to_today
  exit 0
fi

# それ以外は第1引数を「リスト名」とみなす
key="$1"
shift

if is_valid_list "$key"; then
  handle_list "$key" "$@"
else
  echo "Unknown list: $key"
  echo
  print_usage
  exit 1
fi

